-- =============================================================================
-- Add Missing SaleItems - BATCH 1 of 4
-- =============================================================================
-- Purpose: Add line items that were skipped during previous import
-- Date Range: April 2025 - June 2025 (Rows 1-350)
-- =============================================================================

SET NOCOUNT ON;

PRINT '════════════════════════════════════════════════════════════════';
PRINT '  Adding Missing Sale Line Items - BATCH 1 of 4';
PRINT '  Date Range: April 2025 - June 2025';
PRINT '════════════════════════════════════════════════════════════════';
PRINT '';

BEGIN TRY
    BEGIN TRANSACTION;

    -- Safety cleanup from any previous failed run
    IF OBJECT_ID('tempdb..#RawSalesData') IS NOT NULL DROP TABLE #RawSalesData;

    -- Create temp table for raw sales data
    CREATE TABLE #RawSalesData (
        CustomerCode NVARCHAR(50),
        CustomerName NVARCHAR(200),
        ItemSKU NVARCHAR(50),
        ItemDescription NVARCHAR(500),
        Province NVARCHAR(50),
        InvoiceNumber NVARCHAR(50),
        SaleDate DATE,
        Location NVARCHAR(200),
        QuantitySold INT,
        UnitPrice DECIMAL(18,2),
        TotalAmount DECIMAL(18,2)
    );

    PRINT 'Step 1: Loading sales data...';
    
    INSERT INTO #RawSalesData (CustomerCode, CustomerName, ItemSKU, ItemDescription, Province, InvoiceNumber, SaleDate, Location, QuantitySold, UnitPrice, TotalAmount)
    VALUES
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN152428', '2025-04-11', '000', 500.00, 136.53, 68265.22),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN152427', '2025-04-11', '000', 2400.00, 44.84, 107624.35),
    ('01-RKK-001', 'RK KHAN HOSPITAL', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152563', '2025-04-17', '000', 1400.00, 44.84, 62780.87),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN152610', '2025-04-22', '000', 2.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN152616', '2025-04-22', '000', 60.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN152619', '2025-04-22', '000', 420.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN152615', '2025-04-22', '000', 1.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN152621', '2025-04-22', '000', 1.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152614', '2025-04-22', '000', 70.00, 89.13, 6239.13),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152617', '2025-04-22', '000', 200.00, 89.13, 17826.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152622', '2025-04-22', '000', 300.00, 89.13, 26739.13),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN152611', '2025-04-22', '000', 5.00, 3630.43, 18152.17),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN152613', '2025-04-22', '000', 3.00, 3630.43, 10891.30),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN152620', '2025-04-22', '000', 1.00, 3630.43, 3630.43),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152634', '2025-04-23', '000', 700.00, 89.13, 62391.30),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152635', '2025-04-23', '000', 300.00, 89.13, 26739.13),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152644', '2025-04-23', '000', 1000.00, 89.13, 89130.43),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN152773', '2025-05-05', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152831', '2025-05-06', '000', 2600.00, 51.57, 134082.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152898', '2025-05-08', '000', 200.00, 51.57, 10314.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN152899', '2025-05-08', '000', 10.00, 3630.44, 36304.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152977', '2025-05-12', '000', 740.00, 51.57, 38161.80),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152978', '2025-05-12', '000', 80.00, 89.13, 7130.43),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN152980', '2025-05-12', '000', 200.00, 51.57, 10314.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN152979', '2025-05-12', '000', 5.00, 3630.43, 18152.17),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN153152', '2025-05-16', '000', 150.00, 136.53, 20479.56),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN153185', '2025-05-16', '000', 20.00, 136.53, 2730.61),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN153153', '2025-05-16', '000', 600.00, 44.84, 26906.09),
    ('07-NCH-001', 'NC HEALTH DR HARRY SURTIE HOSPITAL', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '07', 'IN153141', '2025-05-16', '000', 100.00, 136.53, 13653.04),
    ('07-NCH-001', 'NC HEALTH DR HARRY SURTIE HOSPITAL', 'NDOH35017', 'GLUCOSE TEST STRIPS', '07', 'IN153141', '2025-05-16', '000', 100.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153205', '2025-05-19', '000', 120.00, 51.57, 6188.40),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN153195', '2025-05-19', '000', 4000.00, 44.84, 179373.91),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN153223', '2025-05-20', '000', 100.00, 0.00, 0.00),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN153237', '2025-05-20', '000', 333.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN153351', '2025-05-21', '000', 300.00, 0.00, 0.00),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN153290', '2025-05-21', '000', 2000.00, 44.84, 89686.96),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN153359', '2025-05-22', '000', 166.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN153458', '2025-05-27', '000', 0.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153458', '2025-05-27', '000', 3000.00, 44.84, 134530.43),
    ('09-DEP-001', 'DEPARTMENT OF HEALTH MPUMALANGA', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '09', 'IN153457', '2025-05-27', '000', 166.00, 0.00, 0.00),
    ('09-DEP-001', 'DEPARTMENT OF HEALTH MPUMALANGA', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN153457', '2025-05-27', '000', 10000.00, 44.84, 448430.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN153494', '2025-05-29', '000', 3.00, 1763.70, 5291.11),
    ('08-WIT-001', 'WITKOPPEN HEALTH & WELFARE CENTRE', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '08', 'IN153515', '2025-05-30', '000', 1.00, 0.00, 0.00),
    ('08-WIT-001', 'WITKOPPEN HEALTH & WELFARE CENTRE', 'NDOH35034', 'HBA1C TEST STRIPS', '08', 'IN153515', '2025-05-30', '000', 4.00, 2028.26, 8113.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153714', '2025-06-03', '000', 10.00, 44.84, 448.43),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153715', '2025-06-03', '000', 20.00, 44.84, 896.87),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153716', '2025-06-03', '000', 200.00, 44.84, 8968.69),
    ('04-CAS-001', 'ECONOCOM 47 C.C. TRADING AS QUALICON CONSTRUCTION', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN153718', '2025-06-03', '000', 7.00, 157.01, 1099.07),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN153889', '2025-06-05', '000', 1500.00, 44.84, 67265.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN153887', '2025-06-05', '000', 10.00, 1763.70, 17637.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN153888', '2025-06-05', '000', 5.00, 3630.43, 18152.17),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154080', '2025-06-10', '000', 400.00, 44.84, 17937.39),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154132', '2025-06-11', '000', 1200.00, 44.84, 53812.17),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN154131', '2025-06-11', '000', 5.00, 1763.70, 8818.52),
    ('02-DEP-004', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '02', 'IN154160', '2025-06-11', '000', 2000.00, 136.53, 273060.87),
    ('02-DEP-004', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '02', 'IN154167', '2025-06-11', '000', 10000.00, 44.84, 448434.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154502', '2025-06-19', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154503', '2025-06-19', '000', 1000.00, 44.84, 44843.48),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN154625', '2025-06-20', '000', 2.00, 2198.25, 4396.49),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154556', '2025-06-20', '000', 1500.00, 44.84, 67265.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154622', '2025-06-20', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154623', '2025-06-20', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN154609', '2025-06-20', '000', 9.00, 1763.70, 15873.34),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN154620', '2025-06-20', '000', 12.00, 1763.70, 21164.45),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN154624', '2025-06-20', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'CN102929', '2025-06-20', '000', -333.00, 0.00, 0.00),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN154578', '2025-06-20', '000', 333.00, 0.00, 0.00),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154690', '2025-06-23', '000', 600.00, 44.84, 26906.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154770', '2025-06-24', '000', 490.00, 44.84, 21973.30),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154781', '2025-06-25', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN154782', '2025-06-25', '000', 20.00, 1763.70, 35274.09),
    ('08-GP1-012', 'SOUTH RAND HOSPITAL', 'NDOH35003', 'HEMOGLOBIN TEST STRIPS', '08', 'IN154843', '2025-06-26', '000', 50.00, 139.35, 6967.39),
    ('08-GP1-012', 'SOUTH RAND HOSPITAL', 'NDOH35013', 'HEMOGLOBIN METER - BATTERY', '08', 'IN154843', '2025-06-26', '000', 50.00, 9.16, 457.83),
    ('08-GP1-012', 'SOUTH RAND HOSPITAL', 'NDOH35014', 'HEMOGLOBIN METER - QUALITY CONTROL SOLUTIONS', '08', 'IN154843', '2025-06-26', '000', 10.00, 120.50, 1205.04),
    ('08-GP1-032', 'EDENVALE GENERAL HOSPITAL', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '08', 'IN154817', '2025-06-26', '000', 20.00, 136.53, 2730.61),
    ('08-GP1-032', 'EDENVALE GENERAL HOSPITAL', 'NDOH35017', 'GLUCOSE TEST STRIPS', '08', 'IN154817', '2025-06-26', '000', 20.00, 44.84, 896.87),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN154910', '2025-06-30', '000', 480.00, 44.84, 21524.87),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'CN102952', '2025-06-30', '000', -333.00, 0.00, 0.00),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN154907', '2025-06-30', '000', 333.00, 0.00, 0.00);

    DECLARE @TotalRows INT = (SELECT COUNT(*) FROM #RawSalesData);
    PRINT '  ✓ Loaded ' + CAST(@TotalRows AS NVARCHAR(10)) + ' rows of sales data';
    PRINT '';

    -- Count existing SaleItems before adding
    DECLARE @ExistingItemsCount INT = (SELECT COUNT(*) FROM SaleItem WHERE IsDeleted = 0);
    PRINT 'Current SaleItems count: ' + CAST(@ExistingItemsCount AS NVARCHAR(10));
    PRINT '';

    PRINT 'Step 2: Adding missing line items to existing invoices...';
    
    -- Insert SaleItem records for existing Sales
    INSERT INTO SaleItem (
        SaleId,
        InventoryItemId,
        Quantity,
        UnitPrice,
        TotalPrice,
        IsDeleted
    )
    SELECT 
        s.Id AS SaleId,
        inv.Id AS InventoryItemId,
        r.QuantitySold,
        r.UnitPrice,
        r.TotalAmount,
        0
    FROM #RawSalesData r
    INNER JOIN Sale s ON r.InvoiceNumber = s.SaleNumber
    INNER JOIN InventoryItem inv ON r.ItemSKU = inv.SKU
    WHERE s.IsDeleted = 0
    AND inv.IsDeleted = 0
    AND NOT EXISTS (
        SELECT 1 FROM SaleItem si
        WHERE si.SaleId = s.Id 
        AND si.InventoryItemId = inv.Id
        AND si.Quantity = r.QuantitySold
        AND si.UnitPrice = r.UnitPrice
        AND si.IsDeleted = 0
    );

    DECLARE @ItemsAdded INT = @@ROWCOUNT;
    PRINT '  ✓ Added ' + CAST(@ItemsAdded AS NVARCHAR(10)) + ' new sale line items';
    PRINT '';

    -- Count total SaleItems after adding
    DECLARE @NewItemsCount INT = (SELECT COUNT(*) FROM SaleItem WHERE IsDeleted = 0);
    PRINT 'New SaleItems count: ' + CAST(@NewItemsCount AS NVARCHAR(10));
    PRINT 'Items added in this batch: ' + CAST((@NewItemsCount - @ExistingItemsCount) AS NVARCHAR(10));
    PRINT '';

    COMMIT TRANSACTION;
    
    PRINT '════════════════════════════════════════════════════════════════';
    PRINT '  ✅ BATCH 1 Complete - Run batch 2 next';
    PRINT '════════════════════════════════════════════════════════════════';

    DROP TABLE #RawSalesData;

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;
    
    PRINT '';
    PRINT '❌ ERROR: ' + ERROR_MESSAGE();
    
    IF OBJECT_ID('tempdb..#RawSalesData') IS NOT NULL
        DROP TABLE #RawSalesData;
    
    THROW;
END CATCH;
