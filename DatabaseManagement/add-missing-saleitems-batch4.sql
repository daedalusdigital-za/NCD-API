-- =============================================================================
-- Add Missing SaleItems - BATCH 4 of 4
-- =============================================================================
-- Purpose: Add line items that were skipped during previous import
-- Date Range: October 2025 - January 2026 (Remaining rows)
-- =============================================================================

SET NOCOUNT ON;

PRINT '════════════════════════════════════════════════════════════════';
PRINT '  Adding Missing Sale Line Items - BATCH 4 of 4';
PRINT '  Date Range: October 2025 - January 2026';
PRINT '════════════════════════════════════════════════════════════════';
PRINT '';

BEGIN TRY
    BEGIN TRANSACTION;

    -- Safety cleanup from any previous failed run
    IF OBJECT_ID('tempdb..#RawSalesData') IS NOT NULL DROP TABLE #RawSalesData;

    CREATE TABLE #RawSalesData (
        CustomerCode NVARCHAR(50),
        CustomerName NVARCHAR(200),
        ItemSKU NVARCHAR(50),
        ItemDescription NVARCHAR(500),
        Province NVARCHAR(50),
        InvoiceNumber NVARCHAR(50),
        SaleDate DATE,
        Location NVARCHAR(200),
        QuantitySold INT,
        UnitPrice DECIMAL(18,2),
        TotalAmount DECIMAL(18,2)
    );

    PRINT 'Step 1: Loading sales data...';
    
    INSERT INTO #RawSalesData (CustomerCode, CustomerName, ItemSKU, ItemDescription, Province, InvoiceNumber, SaleDate, Location, QuantitySold, UnitPrice, TotalAmount)
    VALUES
    -- October 2025 data
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158888', '2025-10-02', '000', 1500.00, 44.84, 67265.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158889', '2025-10-02', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158890', '2025-10-02', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN158891', '2025-10-02', '000', 150.00, 136.53, 20479.56),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN158892', '2025-10-02', '000', 5.00, 2198.24, 10991.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN158893', '2025-10-02', '000', 6.00, 1763.70, 10582.22),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN158910', '2025-10-02', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN158911', '2025-10-02', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158958', '2025-10-03', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158959', '2025-10-03', '000', 600.00, 44.84, 26906.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN158960', '2025-10-03', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN158961', '2025-10-03', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN158962', '2025-10-03', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN158978', '2025-10-03', '000', 300.00, 44.84, 13453.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN158979', '2025-10-03', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN158980', '2025-10-03', '000', 20.00, 136.53, 2730.61),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159022', '2025-10-06', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159023', '2025-10-06', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159024', '2025-10-06', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159025', '2025-10-06', '000', 400.00, 44.84, 17937.39),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN159026', '2025-10-06', '000', 200.00, 136.53, 27306.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN159027', '2025-10-06', '000', 3.00, 2198.24, 6594.73),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN159028', '2025-10-06', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN159045', '2025-10-06', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN159046', '2025-10-06', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN159047', '2025-10-06', '000', 30.00, 136.53, 4095.91),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159089', '2025-10-07', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159090', '2025-10-07', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN159091', '2025-10-07', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN159092', '2025-10-07', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN159093', '2025-10-07', '000', 3.00, 1763.70, 5291.11),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN159105', '2025-10-07', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN159106', '2025-10-07', '000', 50.00, 44.84, 2242.17),
    -- November 2025 data
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160109', '2025-11-03', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160110', '2025-11-03', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160111', '2025-11-03', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN160112', '2025-11-03', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN160113', '2025-11-03', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160127', '2025-11-03', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160128', '2025-11-03', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN160129', '2025-11-03', '000', 20.00, 136.53, 2730.61),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN160253', '2025-11-05', '000', 500.00, 44.84, 22421.74),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN160254', '2025-11-05', '000', 200.00, 44.84, 8968.69),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '09', 'IN160255', '2025-11-05', '000', 50.00, 136.53, 6826.52),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160389', '2025-11-10', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160390', '2025-11-10', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160391', '2025-11-10', '000', 1000.00, 44.84, 44843.48),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN160392', '2025-11-10', '000', 200.00, 136.53, 27306.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN160393', '2025-11-10', '000', 5.00, 2198.24, 10991.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN160394', '2025-11-10', '000', 10.00, 1763.70, 17637.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160456', '2025-11-11', '000', 500.00, 44.84, 22421.74),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160457', '2025-11-11', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN160458', '2025-11-11', '000', 30.00, 136.53, 4095.91),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160567', '2025-11-14', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160568', '2025-11-14', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160569', '2025-11-14', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN160570', '2025-11-14', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN160571', '2025-11-14', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160623', '2025-11-17', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160624', '2025-11-17', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160756', '2025-11-19', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160757', '2025-11-19', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160758', '2025-11-19', '000', 1200.00, 44.84, 53812.17),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN160759', '2025-11-19', '000', 150.00, 136.53, 20479.56),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN160760', '2025-11-19', '000', 3.00, 2198.24, 6594.73),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN160761', '2025-11-19', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160823', '2025-11-20', '000', 300.00, 44.84, 13453.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160824', '2025-11-20', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN160825', '2025-11-20', '000', 20.00, 136.53, 2730.61),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160912', '2025-11-24', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160913', '2025-11-24', '000', 600.00, 44.84, 26906.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN160914', '2025-11-24', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN160915', '2025-11-24', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN160916', '2025-11-24', '000', 3.00, 1763.70, 5291.11),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160968', '2025-11-25', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN160969', '2025-11-25', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN160970', '2025-11-25', '000', 10.00, 136.53, 1365.30),
    -- December 2025 data
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161013', '2025-12-01', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161014', '2025-12-01', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161015', '2025-12-01', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161016', '2025-12-01', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN161017', '2025-12-01', '000', 5.00, 2198.24, 10991.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161018', '2025-12-01', '000', 10.00, 1763.70, 17637.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161078', '2025-12-02', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161079', '2025-12-02', '000', 500.00, 44.84, 22421.74),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161080', '2025-12-02', '000', 50.00, 136.53, 6826.52),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161189', '2025-12-05', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161190', '2025-12-05', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161191', '2025-12-05', '000', 1000.00, 44.84, 44843.48),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161192', '2025-12-05', '000', 200.00, 136.53, 27306.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161193', '2025-12-05', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161245', '2025-12-08', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161246', '2025-12-08', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161247', '2025-12-08', '000', 20.00, 136.53, 2730.61),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN161312', '2025-12-09', '000', 300.00, 44.84, 13453.04),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN161313', '2025-12-09', '000', 500.00, 44.84, 22421.74),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '09', 'IN161314', '2025-12-09', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161423', '2025-12-12', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161424', '2025-12-12', '000', 600.00, 44.84, 26906.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161425', '2025-12-12', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161426', '2025-12-12', '000', 150.00, 136.53, 20479.56),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN161427', '2025-12-12', '000', 3.00, 2198.24, 6594.73),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161428', '2025-12-12', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161489', '2025-12-15', '000', 300.00, 44.84, 13453.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161490', '2025-12-15', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161491', '2025-12-15', '000', 30.00, 136.53, 4095.91),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161534', '2025-12-16', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161535', '2025-12-16', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161536', '2025-12-16', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161537', '2025-12-16', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161538', '2025-12-16', '000', 3.00, 1763.70, 5291.11),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161577', '2025-12-17', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161578', '2025-12-17', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161579', '2025-12-17', '000', 10.00, 136.53, 1365.30),
    -- January 2026 data
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161743', '2026-01-06', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161744', '2026-01-06', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161745', '2026-01-06', '000', 1000.00, 44.84, 44843.48),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161746', '2026-01-06', '000', 200.00, 136.53, 27306.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN161747', '2026-01-06', '000', 5.00, 2198.24, 10991.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161748', '2026-01-06', '000', 10.00, 1763.70, 17637.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161812', '2026-01-07', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161813', '2026-01-07', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161814', '2026-01-07', '000', 50.00, 136.53, 6826.52),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161923', '2026-01-10', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161924', '2026-01-10', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN161925', '2026-01-10', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN161926', '2026-01-10', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN161927', '2026-01-10', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161989', '2026-01-13', '000', 300.00, 44.84, 13453.04),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN161990', '2026-01-13', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN161991', '2026-01-13', '000', 20.00, 136.53, 2730.61),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN162056', '2026-01-14', '000', 500.00, 44.84, 22421.74),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35017', 'GLUCOSE TEST STRIPS', '09', 'IN162057', '2026-01-14', '000', 300.00, 44.84, 13453.04),
    ('09-LIM-001', 'DEPARTMENT OF HEALTH LIMPOPO', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '09', 'IN162058', '2026-01-14', '000', 50.00, 136.53, 6826.52),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162167', '2026-01-17', '000', 200.00, 44.84, 8968.69),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162168', '2026-01-17', '000', 600.00, 44.84, 26906.09),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162169', '2026-01-17', '000', 1200.00, 44.84, 53812.17),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN162170', '2026-01-17', '000', 150.00, 136.53, 20479.56),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35006', 'DUAL GLUCOSE & HBA1C METER- BIOHERMES', '01', 'IN162171', '2026-01-17', '000', 3.00, 2198.24, 6594.73),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN162172', '2026-01-17', '000', 5.00, 1763.70, 8818.52),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN162234', '2026-01-20', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN162235', '2026-01-20', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN162236', '2026-01-20', '000', 30.00, 136.53, 4095.91),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162312', '2026-01-22', '000', 500.00, 44.84, 22421.74),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162313', '2026-01-22', '000', 100.00, 44.84, 4484.35),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162314', '2026-01-22', '000', 800.00, 44.84, 35874.78),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '01', 'IN162315', '2026-01-22', '000', 100.00, 136.53, 13653.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35034', 'HBA1C TEST STRIPS', '01', 'IN162316', '2026-01-22', '000', 3.00, 1763.70, 5291.11),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN162378', '2026-01-24', '000', 200.00, 44.84, 8968.69),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '04', 'IN162379', '2026-01-24', '000', 100.00, 44.84, 4484.35),
    ('04-BLO-001', 'BLOEMFONTEIN MEDICAL DEPOT', 'NDOH35004', 'GLUCOSE METER- BIO HERMES', '04', 'IN162380', '2026-01-24', '000', 10.00, 136.53, 1365.30),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162398', '2026-01-27', '000', 300.00, 44.84, 13453.04),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162399', '2026-01-27', '000', 1500.00, 44.84, 67265.22),
    ('01-PRO-002', 'PROVINCIAL PHARM SUPPLY DEPOT', 'NDOH35017', 'GLUCOSE TEST STRIPS', '01', 'IN162400', '2026-01-27', '000', 500.00, 44.84, 22421.74);

    DECLARE @TotalRows INT = (SELECT COUNT(*) FROM #RawSalesData);
    PRINT '  ✓ Loaded ' + CAST(@TotalRows AS NVARCHAR(10)) + ' rows of sales data';
    PRINT '';

    DECLARE @ExistingItemsCount INT = (SELECT COUNT(*) FROM SaleItem WHERE IsDeleted = 0);
    PRINT 'Current SaleItems count: ' + CAST(@ExistingItemsCount AS NVARCHAR(10));
    PRINT '';

    PRINT 'Step 2: Adding missing line items to existing invoices...';
    
    INSERT INTO SaleItem (SaleId, InventoryItemId, Quantity, UnitPrice, TotalPrice, IsDeleted)
    SELECT s.Id, inv.Id, r.QuantitySold, r.UnitPrice, r.TotalAmount, 0
    FROM #RawSalesData r
    INNER JOIN Sale s ON r.InvoiceNumber = s.SaleNumber
    INNER JOIN InventoryItem inv ON r.ItemSKU = inv.SKU
    WHERE s.IsDeleted = 0 AND inv.IsDeleted = 0
    AND NOT EXISTS (
        SELECT 1 FROM SaleItem si
        WHERE si.SaleId = s.Id AND si.InventoryItemId = inv.Id
        AND si.Quantity = r.QuantitySold AND si.UnitPrice = r.UnitPrice AND si.IsDeleted = 0
    );

    DECLARE @ItemsAdded INT = @@ROWCOUNT;
    PRINT '  ✓ Added ' + CAST(@ItemsAdded AS NVARCHAR(10)) + ' new sale line items';
    PRINT '';

    DECLARE @NewItemsCount INT = (SELECT COUNT(*) FROM SaleItem WHERE IsDeleted = 0);
    PRINT 'New SaleItems count: ' + CAST(@NewItemsCount AS NVARCHAR(10));
    PRINT 'Items added in this batch: ' + CAST((@NewItemsCount - @ExistingItemsCount) AS NVARCHAR(10));

    COMMIT TRANSACTION;
    
    PRINT '';
    PRINT '════════════════════════════════════════════════════════════════';
    PRINT '  ✅ BATCH 4 Complete - ALL BATCHES DONE!';
    PRINT '════════════════════════════════════════════════════════════════';

    DROP TABLE #RawSalesData;

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
    PRINT '❌ ERROR: ' + ERROR_MESSAGE();
    IF OBJECT_ID('tempdb..#RawSalesData') IS NOT NULL DROP TABLE #RawSalesData;
    THROW;
END CATCH;
